# üïâÔ∏è Ubuntu Desktop with VNC for Adobe After Effects via Wine
# "‡§∏‡§æ‡§ß‡•Å‡§µ‡§æ‡§¶" - "–•–æ—Ä–æ—à–æ —Å–¥–µ–ª–∞–Ω–æ"

FROM ubuntu:22.04

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
ENV DEBIAN_FRONTEND=noninteractive
ENV DISPLAY=:1
ENV VNC_PORT=5901
ENV VNC_RESOLUTION=1920x1080
ENV VNC_PASSWORD=railway

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø–∞–∫–µ—Ç–æ–≤
RUN apt-get update && apt-get install -y \
    ubuntu-desktop-minimal \
    xfce4 \
    xfce4-goodies \
    tightvncserver \
    novnc \
    websockify \
    supervisor \
    wget \
    curl \
    software-properties-common \
    apt-transport-https \
    ca-certificates \
    gnupg \
    lsb-release \
    nano \
    htop \
    && rm -rf /var/lib/apt/lists/*

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Wine
RUN dpkg --add-architecture i386 \
    && mkdir -p /etc/apt/keyrings \
    && wget -qO /etc/apt/keyrings/winehq-archive.key https://dl.winehq.org/wine-builds/winehq.key \
    && wget -NP /etc/apt/sources.list.d/ https://dl.winehq.org/wine-builds/ubuntu/dists/jammy/winehq-jammy.sources \
    && apt-get update \
    && apt-get install -y --install-recommends winehq-stable winetricks

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js
RUN curl -fsSL https://deb.nodesource.com/setup_18.x | bash - \
    && apt-get install -y nodejs \
    && npm install -g pnpm

# –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
RUN useradd -m -s /bin/bash ubuntu \
    && echo "ubuntu:railway" | chpasswd \
    && usermod -aG sudo ubuntu

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ VNC –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ubuntu
USER ubuntu
WORKDIR /home/ubuntu

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ VNC —Å–µ—Ä–≤–µ—Ä–∞
RUN mkdir -p ~/.vnc \
    && echo "$VNC_PASSWORD" | vncpasswd -f > ~/.vnc/passwd \
    && chmod 600 ~/.vnc/passwd

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ XFCE –∫–∞–∫ —Ä–∞–±–æ—á–µ–≥–æ —Å—Ç–æ–ª–∞ –¥–ª—è VNC
RUN echo "#!/bin/bash" > ~/.vnc/xstartup \
    && echo "xrdb $HOME/.Xresources" >> ~/.vnc/xstartup \
    && echo "startxfce4 &" >> ~/.vnc/xstartup \
    && chmod +x ~/.vnc/xstartup

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Wine
ENV WINEPREFIX=/home/ubuntu/.wine
ENV WINEARCH=win64

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞
USER root
COPY --chown=ubuntu:ubuntu . /home/ubuntu/nexrender-server
WORKDIR /home/ubuntu/nexrender-server

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –ø—Ä–æ–µ–∫—Ç–∞
USER ubuntu
RUN pnpm install

# –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç–∞—Ä—Ç–æ–≤–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞
USER root
COPY <<EOF /start.sh
#!/bin/bash
set -e

# –ó–∞–ø—É—Å–∫ VNC —Å–µ—Ä–≤–µ—Ä–∞
su ubuntu -c "vncserver :1 -geometry $VNC_RESOLUTION -depth 24"

# –ó–∞–ø—É—Å–∫ noVNC –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
websockify --web=/usr/share/novnc/ 6080 localhost:5901 &

# –ó–∞–ø—É—Å–∫ Nexrender —Å–µ—Ä–≤–µ—Ä–∞
su ubuntu -c "cd /home/ubuntu/nexrender-server && pnpm run dev:server" &

# –í—ã–≤–æ–¥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
echo "üñ•Ô∏è Ubuntu Desktop –¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ VNC:"
echo "   - VNC: localhost:5901 (–ø–∞—Ä–æ–ª—å: railway)"
echo "   - Web: http://localhost:6080/vnc.html"
echo "üöÄ Nexrender Server: http://localhost:3000"

# –û–∂–∏–¥–∞–Ω–∏–µ
tail -f /dev/null
EOF

RUN chmod +x /start.sh

# –≠–∫—Å–ø–æ—Ä—Ç –ø–æ—Ä—Ç–æ–≤
EXPOSE 5901 6080 3000

# –ó–∞–ø—É—Å–∫
CMD ["/start.sh"]
